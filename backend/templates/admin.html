<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <title>לוח מנהל</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="bg-light p-3">
    <h2>לוח מנהל</h2>

    <h4>צור הגרלה לתורנות</h4>
    <form id="generate-form" class="mb-4 p-3 bg-white rounded shadow-sm">
        <div class="mb-2">
            <label for="class-select">בחר כיתה:</label>
            <select id="class-select" class="form-select" required></select>
        </div>
        <div class="mb-2">
            <label for="start-date">תאריך התחלה:</label>
            <input type="date" id="start-date" class="form-control" required>
        </div>
        <div class="mb-2">
            <label for="end-date">תאריך סיום:</label>
            <input type="date" id="end-date" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary mt-2">צור הגרלה</button>
    </form>

    <h4>תורנים</h4>
    <div id="users-table"></div>

    <script>
        // טען כיתות ל-dropdown
        async function loadClassesDropdown() {
            const res = await fetch("/classes");
            const classes = await res.json();
            const select = document.getElementById("class-select");
            select.innerHTML = "";
            classes.forEach(c => {
                const option = document.createElement("option");
                option.value = c.id;
                option.textContent = c.name;
                select.appendChild(option);
            });
        }

        // טען את המשתמשים בטבלה
        async function loadUsers() {
            const res = await fetch("/users");
            const users = await res.json();
            const container = document.getElementById("users-table");
            container.innerHTML = "<table class='table table-striped'><tr><th>שם</th><th>אימייל</th><th>כיתה</th><th>מחיקה</th></tr>" +
                users.map(u => `<tr>
                    <td>${u.name}</td>
                    <td>${u.email}</td>
                    <td>${u.class_id}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">מחק</button></td>
                </tr>`).join("") + "</table>";
        }

        // מחיקת משתמש
        async function deleteUser(id) {
            await fetch("/delete_user", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({id})
            });
            loadUsers();
        }

        // טיפול בהגרלה
        document.getElementById("generate-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const class_id = document.getElementById("class-select").value;
            const start_date = document.getElementById("start-date").value;
            const end_date = document.getElementById("end-date").value;

            const res = await fetch("/generate_schedule", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({class_id, start_date, end_date})
            });
            const data = await res.json();
            if(res.ok){
                alert("הגרלה נוצרה בהצלחה!");
                loadUsers();
            } else {
                alert("שגיאה: " + data.error);
            }
        });

        loadClassesDropdown();
        loadUsers();
    </script>
</body>
</html>
